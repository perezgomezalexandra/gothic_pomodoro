<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pomodoro GÃ³tico â€” Notion Widget</title>
<style>
  :root{
    --bg: #0b0b10;
    --text: #e8e8ea;
    --muted: #a1a1aa;
    --accent: #b300ff; /* morado neÃ³n por defecto */
    --accent-2: #ff0040; /* rojo magenta para detalles */
    --card: rgba(10,10,14,0.55);
    --ring-bg: rgba(255,255,255,0.06);
    --blur: 1.5px;
    --grain: 0.35;
    --radius: 16px;
    --shadow: 0 10px 30px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.06);
  }
  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
  }
  .wrap {
    position: relative;
    min-height: 100%;
    display: grid;
    place-items: center;
    overflow: hidden;
  }
  /* Fondo gÃ³tico con imagen + viÃ±eta + grano */
  .bg {
    position:absolute; inset:0;
    background: var(--bg) center/cover no-repeat;
    filter: blur(var(--blur));
    transform: scale(1.03);
  }
  .vignette {
    position:absolute; inset:-10%;
    pointer-events:none;
    background:
      radial-gradient(ellipse at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.15) 45%, rgba(0,0,0,0.55) 100%),
      linear-gradient(60deg, rgba(179,0,255,0.06), rgba(255,0,64,0.06));
    mix-blend-mode: normal;
  }
  .grain {
    position:absolute; inset:0; pointer-events:none; opacity: var(--grain);
    background-image: url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120">\
        <filter id="n"><feTurbulence baseFrequency="0.8" numOctaves="2" seed="7" type="fractalNoise"/></filter>\
        <rect width="100%" height="100%" filter="url(%23n)"></rect>\
      </svg>');
    background-size: 160px 160px;
    mix-blend-mode: overlay;
  }
  .card {
    position: relative;
    width: min(520px, 92vw);
    border-radius: var(--radius);
    padding: 20px 18px;
    background: var(--card);
    backdrop-filter: blur(8px) saturate(120%);
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.08);
  }
  .header {
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom: 8px;
  }
  .title {
    font-weight: 700; letter-spacing: 0.3px;
    display:flex; align-items:center; gap:10px;
  }
  .badge {
    font-size: 12px; padding: 4px 8px; border-radius: 999px; color: var(--accent);
    background: rgba(179,0,255,0.12); border: 1px solid rgba(179,0,255,0.25);
  }
  .modes {
    display:flex; gap:8px; flex-wrap: wrap;
  }
  .chip {
    appearance:none; border:1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.02);
    color: var(--text);
    padding: 6px 10px; border-radius: 999px; font-size: 13px;
    cursor: pointer; transition: .15s ease;
  }
  .chip.active { border-color: var(--accent); color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
  .main {
    display:grid; justify-items:center; gap:16px; padding: 14px 6px 8px;
  }
  .ring {
    width: 240px; height: 240px; position: relative;
  }
  .ring svg { width: 100%; height: 100%; display:block; }
  .time {
    position:absolute; inset:0; display:grid; place-items:center;
    font-variant-numeric: tabular-nums; font-size: 42px; font-weight: 800;
    text-shadow: 0 0 18px rgba(179,0,255,0.35);
  }
  .controls { display:flex; gap:10px; flex-wrap: wrap; justify-content:center; }
  button.btn {
    appearance:none; border:1px solid rgba(255,255,255,0.16);
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    color: var(--text); padding: 10px 14px; border-radius: 12px; font-weight:700; letter-spacing:.3px;
    cursor:pointer; transition:.2s ease; box-shadow: var(--shadow);
  }
  button.btn.primary {
    border-color: var(--accent);
    box-shadow: 0 6px 20px rgba(179,0,255,0.35), inset 0 0 0 1px var(--accent);
    text-shadow: 0 0 10px rgba(179,0,255,0.45);
  }
  button.btn:active { transform: translateY(1px); }
  .config {
    display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top: 10px;
  }
  .field {
    background: rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.12);
    border-radius: 12px; padding: 8px; text-align:center; font-size:12px; color: var(--muted);
  }
  .field input {
    width: 100%; margin-top: 4px; background: transparent; border: 1px dashed rgba(255,255,255,0.15);
    color: var(--text); padding: 6px; border-radius: 8px; text-align:center; font-weight:700;
    font-variant-numeric: tabular-nums;
  }
  .footer {
    margin-top: 10px; display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 12px; color: var(--muted);
  }
  .link { color: var(--accent); text-decoration: none; border-bottom: 1px dotted var(--accent); }
  @media (max-width: 380px) {
    .ring { width: 200px; height: 200px; }
    .time { font-size: 36px; }
  }
</style>
</head>
<body>
<div class="wrap" role="application">
  <div class="bg" id="bg"></div>
  <div class="vignette"></div>
  <div class="grain"></div>

  <div class="card" aria-label="Temporizador Pomodoro">
    <div class="header">
      <div class="title">
        <span>â›§ Pomodoro</span>
        <span class="badge">gothic</span>
      </div>
      <div class="modes" role="tablist" aria-label="Modos">
        <button class="chip active" data-mode="work" role="tab" aria-selected="true" title="Trabajo">Trabajo</button>
        <button class="chip" data-mode="short" role="tab" aria-selected="false" title="Descanso corto">Corto</button>
        <button class="chip" data-mode="long" role="tab" aria-selected="false" title="Descanso largo">Largo</button>
      </div>
    </div>

    <div class="main">
      <div class="ring" aria-live="polite">
        <svg viewBox="0 0 120 120" aria-hidden="true">
          <defs>
            <linearGradient id="g">
              <stop offset="0%" stop-color="var(--accent)"/>
              <stop offset="100%" stop-color="var(--accent-2)"/>
            </linearGradient>
          </defs>
          <circle cx="60" cy="60" r="54" stroke="var(--ring-bg)" stroke-width="8" fill="none"/>
          <circle id="arc" cx="60" cy="60" r="54" stroke="url(#g)" stroke-width="8" fill="none"
                  stroke-linecap="round" transform="rotate(-90 60 60)" stroke-dasharray="339.292" stroke-dashoffset="339.292"/>
        </svg>
        <div class="time" id="time">25:00</div>
      </div>

      <div class="controls">
        <button class="btn primary" id="toggle" aria-pressed="false">Iniciar</button>
        <button class="btn" id="reset">Reiniciar</button>
        <button class="btn" id="skip">Saltar</button>
      </div>

      <div class="config" aria-label="ConfiguraciÃ³n">
        <div class="field">
          Trabajo (min)
          <input id="work" type="number" min="1" max="120" value="25" inputmode="numeric" />
        </div>
        <div class="field">
          Corto (min)
          <input id="short" type="number" min="1" max="60" value="5" inputmode="numeric" />
        </div>
        <div class="field">
          Largo (min)
          <input id="long" type="number" min="1" max="90" value="15" inputmode="numeric" />
        </div>
      </div>

      <div class="footer">
        <div id="status">SesiÃ³n 1 â€¢ Largo cada 4</div>
        <a class="link" href="#" id="mute">ðŸ”” sonido</a>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Utilidades
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
  const params = new URLSearchParams(location.search);
  const setVar = (k,v)=>document.documentElement.style.setProperty(k, v);

  // Theming por parÃ¡metros
  const bgUrl = params.get('bg');
  const accent = params.get('accent');
  const text = params.get('text');
  const blur = params.get('blur');
  const grain = params.get('grain');

  if (bgUrl) qs('#bg').style.backgroundImage = `url("${bgUrl}")`;
  if (accent) setVar('--accent', accent);
  if (text) setVar('--text', text);
  if (blur) setVar('--blur', `${parseFloat(blur)}px`);
  if (grain) setVar('--grain', Math.max(0, Math.min(1, parseFloat(grain))));

  // Estado
  const state = {
    mode: 'work', // 'work' | 'short' | 'long'
    running: false,
    startTs: null,
    duration: 25*60, // en segundos
    remaining: 25*60,
    session: 1,
    cyclesUntilLong: 4,
    muted: false,
    tickRAF: null
  };

  // Persistencia simple
  try {
    const saved = JSON.parse(localStorage.getItem('goth-pomodoro') || '{}');
    if (saved && typeof saved === 'object') {
      Object.assign(state, saved, { running: false, startTs: null, tickRAF: null });
    }
  } catch {}
  function persist(){
    const {tickRAF, startTs, ...safe} = state;
    localStorage.setItem('goth-pomodoro', JSON.stringify(safe));
  }

  // Elementos
  const timeEl = qs('#time');
  const arc = qs('#arc');
  const toggle = qs('#toggle');
  const reset = qs('#reset');
  const skip = qs('#skip');
  const chips = qsa('.chip');
  const workIn = qs('#work');
  const shortIn = qs('#short');
  const longIn = qs('#long');
  const statusEl = qs('#status');
  const muteLink = qs('#mute');

  // Inicializar entradas con persistencia si existe
  if (state._work) workIn.value = state._work;
  if (state._short) shortIn.value = state._short;
  if (state._long) longIn.value = state._long;

  // Utilidad: configurar modo
  function minutesFor(mode){
    if (mode==='work') return parseInt(workIn.value || '25', 10);
    if (mode==='short') return parseInt(shortIn.value || '5', 10);
    return parseInt(longIn.value || '15', 10);
  }
  function setMode(mode, keepRunning=false){
    state.mode = mode;
    chips.forEach(c=>{
      const on = c.dataset.mode===mode;
      c.classList.toggle('active', on);
      c.setAttribute('aria-selected', on ? 'true' : 'false');
    });
    state.duration = minutesFor(mode)*60;
    state.remaining = state.duration;
    state.startTs = null;
    updateUI();
    if (keepRunning) start();
    persist();
  }

  // Formatear tiempo
  function fmt(sec){
    const s = Math.max(0, Math.round(sec));
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${m.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}`;
  }

  // Dibujar anillo
  const CIRC = 2*Math.PI*54; // stroke length
  function drawProgress(){
    const p = 1 - (state.remaining / state.duration);
    arc.style.strokeDasharray = `${CIRC}`;
    arc.style.strokeDashoffset = `${CIRC * (1 - p)}`;
  }

  // Sonido (WebAudio, sin assets externos)
  let audioCtx = null;
  function ping(){
    if (state.muted) return;
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(880, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.2, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.35);
      o.connect(g).connect(audioCtx.destination);
      o.start(now); o.stop(now+0.4);
      // segundo ding
      const o2 = audioCtx.createOscillator();
      const g2 = audioCtx.createGain();
      o2.type = 'triangle';
      o2.frequency.setValueAtTime(660, now+0.42);
      g2.gain.setValueAtTime(0.0001, now+0.42);
      g2.gain.exponentialRampToValueAtTime(0.18, now+0.44);
      g2.gain.exponentialRampToValueAtTime(0.0001, now+0.8);
      o2.connect(g2).connect(audioCtx.destination);
      o2.start(now+0.42); o2.stop(now+0.85);
    } catch {}
  }

  // Ticker
  function tick(){
    if (!state.running) return;
    const now = Date.now();
    const elapsed = (now - state.startTs) / 1000;
    state.remaining = Math.max(0, state.duration - elapsed);
    updateUI();
    if (state.remaining <= 0.01) {
      completePhase();
    } else {
      state.tickRAF = requestAnimationFrame(tick);
    }
  }

  function start(){
    if (state.running) return;
    state.running = true;
    state.startTs = Date.now() - ((state.duration - state.remaining) * 1000);
    toggle.textContent = 'Pausar';
    toggle.setAttribute('aria-pressed', 'true');
    tick();
    persist();
  }
  function pause(){
    if (!state.running) return;
    state.running = false;
    cancelAnimationFrame(state.tickRAF);
    toggle.textContent = 'Reanudar';
    toggle.setAttribute('aria-pressed', 'false');
    persist();
  }
  function resetTimer(){
    state.running = false;
    cancelAnimationFrame(state.tickRAF);
    state.remaining = state.duration = minutesFor(state.mode)*60;
    state.startTs = null;
    toggle.textContent = 'Iniciar';
    toggle.setAttribute('aria-pressed', 'false');
    updateUI();
    persist();
  }
  function skipPhase(){
    state.remaining = 0;
    completePhase();
  }
  function completePhase(){
    pause();
    state.remaining = 0;
    updateUI();
    ping();

    // LÃ³gica de ciclos
    if (state.mode === 'work') {
      // al terminar trabajo, decidir descanso
      if (state.session % state.cyclesUntilLong === 0) {
        setMode('long');
      } else {
        setMode('short');
      }
    } else {
      // al terminar descanso, subir sesiÃ³n y volver a trabajo
      if (state.mode !== 'work') {
        state.session += 1;
      }
      setMode('work');
    }
    persist();
  }

  function updateUI(){
    timeEl.textContent = fmt(state.remaining);
    drawProgress();
    statusEl.textContent = `SesiÃ³n ${state.session} â€¢ Largo cada ${state.cyclesUntilLong}`;
  }

  // Eventos
  toggle.addEventListener('click', ()=> state.running ? pause() : start());
  reset.addEventListener('click', resetTimer);
  skip.addEventListener('click', skipPhase);

  chips.forEach(c => c.addEventListener('click', ()=>{
    const m = c.dataset.mode;
    setMode(m);
  }));

  [workIn, shortIn, longIn].forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const val = Math.max(parseInt(inp.min,10), Math.min(parseInt(inp.max,10), parseInt(inp.value||'0',10)));
      inp.value = isFinite(val) ? val : inp.min;
      state._work = workIn.value;
      state._short = shortIn.value;
      state._long = longIn.value;
      // Si cambias el modo actual, resetea duraciÃ³n
      state.duration = minutesFor(state.mode)*60;
      state.remaining = Math.min(state.remaining, state.duration);
      persist();
      updateUI();
    });
  });

  muteLink.addEventListener('click', (e)=>{
    e.preventDefault();
    state.muted = !state.muted;
    muteLink.textContent = state.muted ? 'ðŸ”• silenciado' : 'ðŸ”” sonido';
    persist();
  });

  // Primera pintura
  setMode(state.mode); // respeta modo guardado
  state.running = false; // nunca auto-empieza al cargar en Notion
  toggle.textContent = 'Iniciar';
  updateUI();
})();
</script>
</body>
</html>
